# ═══════════════════════════════════════════════════════════════════════════════
# G-NAF Mirror Sync Workflow
# ═══════════════════════════════════════════════════════════════════════════════
# This workflow syncs the latest G-NAF data from data.gov.au to the AddressKit
# mirror at dl.addresskit.com.au.
#
# Schedule: Runs on the 18th of every month (G-NAF is typically released mid-month)
# Manual: Can be triggered manually via workflow_dispatch
#
# Copy this file to .github/workflows/gnaf-sync.yml in your repository
# ═══════════════════════════════════════════════════════════════════════════════

name: G-NAF Mirror Sync

on:
  # Run on the 18th of every month at 06:00 UTC
  # G-NAF is typically released around the 15th-17th of each quarter
  schedule:
    - cron: '0 6 18 * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual uploads)'
        required: false
        default: 'false'
        type: boolean
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '22'

jobs:
  check-for-updates:
    name: Check for G-NAF Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      package_modified: ${{ steps.check.outputs.package_modified }}
    
    steps:
      - name: Check G-NAF Package
        id: check
        run: |
          echo "Fetching G-NAF package metadata..."
          PACKAGE_DATA=$(curl -sS "https://data.gov.au/api/3/action/package_show?id=19432f89-dc3a-4ef3-b943-5326ef1dbecc")
          MODIFIED=$(echo "$PACKAGE_DATA" | jq -r '.result.metadata_modified')
          echo "Package last modified: $MODIFIED"
          echo "package_modified=$MODIFIED" >> "$GITHUB_OUTPUT"
          
          # Check if our mirror config exists and compare dates
          MIRROR_CONFIG=$(curl -sS "https://dl.addresskit.com.au/package_show.conf.json" 2>/dev/null || echo '{}')
          MIRROR_MODIFIED=$(echo "$MIRROR_CONFIG" | jq -r '.source_modified // "1970-01-01"')
          echo "Mirror last synced: $MIRROR_MODIFIED"
          
          if [ "$MODIFIED" != "$MIRROR_MODIFIED" ]; then
            echo "Updates available!"
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
          else
            echo "Mirror is up to date"
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          fi

  sync:
    name: Sync G-NAF Data
    runs-on: ubuntu-latest
    needs: check-for-updates
    # Run if updates available OR if manually triggered
    if: needs.check-for-updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 120  # 2 hours max (large file downloads)
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Dependencies
        working-directory: infra/cloudflare/gnaf-sync
        run: pnpm install

      - name: Run Sync
        working-directory: infra/cloudflare/gnaf-sync
        env:
          DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
          DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
          DO_SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
          DO_SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
          MIRROR_BASE_URL: https://dl.addresskit.com.au
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "${{ github.event.inputs.verbose }}" == "true" ]; then
            ARGS="$ARGS --verbose"
          fi
          pnpm sync $ARGS

      - name: Notify on Success
        if: success()
        run: |
          echo "✅ G-NAF mirror sync completed successfully!"
          echo "Mirror URL: https://dl.addresskit.com.au/package_show.conf.json"
          echo "Package modified: ${{ needs.check-for-updates.outputs.package_modified }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "❌ G-NAF mirror sync failed!"
          echo "Check the logs above for details."
          exit 1

