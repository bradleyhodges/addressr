# ═══════════════════════════════════════════════════════════════════════════════
# AddressKit Development Docker Compose
# ═══════════════════════════════════════════════════════════════════════════════
# Builds from local source for development and testing.
#
# Usage:
#   docker compose -f compose.dev.yml up -d        # Start services
#   docker compose -f compose.dev.yml run loader   # Load G-NAF data
#   docker compose -f compose.dev.yml down -v      # Stop and clean up
# ═══════════════════════════════════════════════════════════════════════════════

name: addresskit-dev

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # OpenSearch - Search and indexing backend
  # ─────────────────────────────────────────────────────────────────────────────
  opensearch:
    image: opensearchproject/opensearch:${OPENSEARCH_VERSION:-1.3.20}
    container_name: addresskit-dev-opensearch
    hostname: opensearch
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_JAVA_OPTS=-Xms${OPENSEARCH_HEAP:-1g} -Xmx${OPENSEARCH_HEAP:-1g}
      - bootstrap.memory_lock=true
    ports:
      - "${OPENSEARCH_PORT:-9200}:9200"
      - "${OPENSEARCH_TRANSPORT_PORT:-9300}:9300"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=5s >/dev/null || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 40
      start_period: 30s
    restart: unless-stopped
    networks:
      - addresskit-dev

  # ─────────────────────────────────────────────────────────────────────────────
  # AddressKit Loader - Loads G-NAF data (built from local source)
  # ─────────────────────────────────────────────────────────────────────────────
  loader:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
      args:
        PACKAGE: "@bradleyhodges/addresskit"
        VERSION: "${VERSION:-latest}"
        PACKAGE_TGZ: "bradleyhodges-addresskit-${VERSION:-2.4.4}.tgz"
        BUILD_DATE: "${BUILD_DATE:-}"
        VCS_REF: "${VCS_REF:-}"
    container_name: addresskit-dev-loader
    environment:
      # OpenSearch connection
      - ELASTIC_HOST=opensearch
      - ELASTIC_PORT=9200
      - ELASTIC_PROTOCOL=http
      # Index configuration
      - ES_INDEX_NAME=${ES_INDEX_NAME:-addresskit}
      - ES_CLEAR_INDEX=${ES_CLEAR_INDEX:-false}
      # Loading options
      - COVERED_STATES=${COVERED_STATES:-ACT}
      - ADDRESSKIT_ENABLE_GEO=${ADDRESSKIT_ENABLE_GEO:-false}
      # Download retry configuration (for reliable G-NAF downloads)
      - ADDRESSKIT_DOWNLOAD_MAX_RETRIES=${ADDRESSKIT_DOWNLOAD_MAX_RETRIES:-5}
      - ADDRESSKIT_DOWNLOAD_BACKOFF_INITIAL=${ADDRESSKIT_DOWNLOAD_BACKOFF_INITIAL:-5000}
      - ADDRESSKIT_DOWNLOAD_BACKOFF_MAX=${ADDRESSKIT_DOWNLOAD_BACKOFF_MAX:-60000}
      - ADDRESSKIT_DOWNLOAD_SOCKET_TIMEOUT=${ADDRESSKIT_DOWNLOAD_SOCKET_TIMEOUT:-30000}
      - ADDRESSKIT_DOWNLOAD_CONNECT_TIMEOUT=${ADDRESSKIT_DOWNLOAD_CONNECT_TIMEOUT:-30000}
      # G-NAF mirror configuration (CDN-powered for faster, more reliable downloads)
      - GNAF_USE_MIRROR=${GNAF_USE_MIRROR:-true}
      - GNAF_MIRROR_URL=${GNAF_MIRROR_URL:-https://dl.addresskit.com.au/package_show.conf.json}
      # Resource management
      - ADDRESSKIT_DYNAMIC_RESOURCES=true
      - ADDRESSKIT_TARGET_MEMORY_UTILIZATION=0.7
      # Development logging
      - VERBOSE=${VERBOSE:-true}
      - DEBUG=api,error,loader
      - NODE_ENV=development
    volumes:
      - gnaf-data:/home/node/gnaf
    depends_on:
      opensearch:
        condition: service_healthy
    command: ["addresskit", "load"]
    restart: "no"
    # DNS configuration for reliable external network access
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    networks:
      - addresskit-dev

  # ─────────────────────────────────────────────────────────────────────────────
  # AddressKit API - REST API server (built from local source)
  # ─────────────────────────────────────────────────────────────────────────────
  api:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
      args:
        PACKAGE: "@bradleyhodges/addresskit"
        VERSION: "${VERSION:-latest}"
        PACKAGE_TGZ: "bradleyhodges-addresskit-${VERSION:-2.4.4}.tgz"
        BUILD_DATE: "${BUILD_DATE:-}"
        VCS_REF: "${VCS_REF:-}"
    container_name: addresskit-dev-api
    hostname: api
    environment:
      # OpenSearch connection
      - ELASTIC_HOST=opensearch
      - ELASTIC_PORT=9200
      - ELASTIC_PROTOCOL=http
      # Server configuration
      - PORT=7234
      - NODE_ENV=development
      # Index configuration
      - ES_INDEX_NAME=${ES_INDEX_NAME:-addresskit}
      # CORS settings (allow all origins in dev)
      - ADDRESSKIT_ACCESS_CONTROL_ALLOW_ORIGIN=*
      # Caching configuration
      - ADDRESSKIT_CACHE_ENABLED=true
      - ADDRESSKIT_CACHE_MAX_ENTRIES=1000
      - ADDRESSKIT_CACHE_TTL_MS=300000
      # Development logging
      - VERBOSE=${VERBOSE:-true}
      - DEBUG=api,error
    ports:
      - "${API_PORT:-7234}:7234"
    depends_on:
      opensearch:
        condition: service_healthy
    command: ["addresskit", "start", "--daemon", "--port", "7234"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/home/node/healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - addresskit-dev

  # ─────────────────────────────────────────────────────────────────────────────
  # OpenSearch Dashboards - For development monitoring
  # ─────────────────────────────────────────────────────────────────────────────
  dashboards:
    image: opensearchproject/opensearch-dashboards:${OPENSEARCH_VERSION:-1.3.20}
    container_name: addresskit-dev-dashboards
    profiles:
      - monitoring
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch:9200"]
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "${DASHBOARDS_PORT:-5601}:5601"
    depends_on:
      opensearch:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - addresskit-dev

volumes:
  opensearch-data:
    name: addresskit-dev-opensearch-data
  gnaf-data:
    name: addresskit-dev-gnaf-data

networks:
  addresskit-dev:
    name: addresskit-dev
    driver: bridge
